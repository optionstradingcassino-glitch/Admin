<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cassino Trade â€” Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet" />

  <!-- Supabase CDN â€” must load BEFORE our script -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #080c14;
      --surface: #0e1520;
      --border: #1a2535;
      --accent: #f0b429;
      --accent2: #3b82f6;
      --green: #22c55e;
      --red: #ef4444;
      --text: #e2e8f0;
      --muted: #64748b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* â”€â”€ LOGIN â”€â”€ */
    #loginScreen {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh;
      background: radial-gradient(ellipse at 50% 40%, #0f1e35 0%, #080c14 70%);
    }
    .login-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; padding: 48px 40px; width: 360px; text-align: center;
    }
    .login-box h1 { font-family: 'Syne', sans-serif; font-size: 22px; color: var(--accent); margin-bottom: 6px; letter-spacing: 2px; }
    .login-box p { color: var(--muted); font-size: 12px; margin-bottom: 32px; }
    .login-box input {
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px 16px; color: var(--text);
      font-family: 'JetBrains Mono', monospace; font-size: 14px; margin-bottom: 16px; outline: none;
    }
    .login-box input:focus { border-color: var(--accent); }
    #loginError { color: var(--red); font-size: 12px; margin-top: 12px; display: none; }

    /* â”€â”€ BUTTONS â”€â”€ */
    .btn { padding: 11px 20px; border: none; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.15s; }
    .btn:hover { opacity: 0.85; }
    .btn-primary { background: var(--accent); color: #000; width: 100%; }
    .btn-green { background: var(--green); color: #000; }
    .btn-blue { background: var(--accent2); color: #fff; }
    .btn-red { background: var(--red); color: #fff; }
    .btn-ghost { background: var(--border); color: var(--text); }

    /* â”€â”€ DASHBOARD â”€â”€ */
    #dashboard { display: none; }
    header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 16px 32px; display: flex; align-items: center; justify-content: space-between;
    }
    header h1 { font-family: 'Syne', sans-serif; font-size: 18px; color: var(--accent); letter-spacing: 2px; }
    header span { color: var(--muted); font-size: 12px; }
    nav { display: flex; gap: 4px; padding: 16px 32px; border-bottom: 1px solid var(--border); background: var(--surface); flex-wrap: wrap; }
    .nav-btn { padding: 8px 16px; border: none; border-radius: 6px; background: transparent; color: var(--muted); font-family: 'JetBrains Mono', monospace; font-size: 12px; cursor: pointer; transition: all 0.15s; }
    .nav-btn:hover { color: var(--text); background: var(--border); }
    .nav-btn.active { background: var(--accent); color: #000; font-weight: 700; }
    main { padding: 32px; max-width: 1200px; margin: 0 auto; }
    .tab { display: none; }
    .tab.active { display: block; }

    /* â”€â”€ STAT CARDS â”€â”€ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .stat-card .label { color: var(--muted); font-size: 11px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
    .stat-card .value { font-size: 24px; font-weight: 700; color: var(--accent); }
    .stat-card .sub { color: var(--muted); font-size: 11px; margin-top: 4px; }

    /* â”€â”€ CARD + TABLE â”€â”€ */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 24px; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .card-header h3 { font-size: 13px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { padding: 12px 16px; text-align: left; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
    td { padding: 12px 16px; border-bottom: 1px solid #0a1018; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.02); }

    /* â”€â”€ BADGES â”€â”€ */
    .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; }
    .badge-open    { background: rgba(34,197,94,0.15);  color: var(--green); }
    .badge-closed  { background: rgba(239,68,68,0.15);  color: var(--red); }
    .badge-settled { background: rgba(100,116,139,0.15);color: var(--muted); }
    .badge-yes     { background: rgba(34,197,94,0.15);  color: var(--green); }
    .badge-no      { background: rgba(239,68,68,0.15);  color: var(--red); }
    .badge-admin   { background: rgba(240,180,41,0.15); color: var(--accent); }
    .badge-user    { background: rgba(100,116,139,0.15);color: var(--muted); }

    /* â”€â”€ FORM â”€â”€ */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
    .form-group input, .form-group select {
      background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      padding: 10px 14px; color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 13px; outline: none;
    }
    .form-group input:focus { border-color: var(--accent); }
    .form-group.full { grid-column: 1 / -1; }
    .form-actions { margin-top: 20px; }

    .result-select {
      background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
      padding: 4px 8px; color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 12px; cursor: pointer;
    }
    .adj-input {
      width: 90px; background: var(--bg); border: 1px solid var(--border);
      border-radius: 6px; padding: 4px 8px; color: var(--text);
      font-family: 'JetBrains Mono', monospace; font-size: 12px;
    }
    .loading { color: var(--muted); font-size: 13px; padding: 24px; text-align: center; }

    /* â”€â”€ TOAST â”€â”€ */
    #toast {
      position: fixed; bottom: 24px; right: 24px;
      padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 700;
      display: none; z-index: 999; animation: slideIn 0.2s ease;
    }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€ -->
<div id="loginScreen">
  <div class="login-box">
    <h1>âš¡ CASSINO TRADE</h1>
    <p>Admin Dashboard â€” Restricted Access</p>
    <input type="password" id="passwordInput" placeholder="Enter admin password" />
    <!-- FIX: onclick calls the global login() function defined below -->
    <button class="btn btn-primary" onclick="login()">LOGIN</button>
    <div id="loginError">Wrong password. Try again.</div>
  </div>
</div>

<!-- â”€â”€ DASHBOARD â”€â”€ -->
<div id="dashboard">
  <header>
    <h1>âš¡ CASSINO TRADE ADMIN</h1>
    <span id="clockDisplay"></span>
  </header>
  <nav>
    <button class="nav-btn active" onclick="switchTab('analytics', this)">ðŸ“Š Analytics</button>
    <button class="nav-btn" onclick="switchTab('markets', this)">ðŸŽ¯ Markets</button>
    <button class="nav-btn" onclick="switchTab('create', this)">âž• Create Market</button>
    <button class="nav-btn" onclick="switchTab('users', this)">ðŸ‘¥ Users & Wallets</button>
    <button class="nav-btn" onclick="switchTab('ledger', this)">ðŸ“’ Ledger</button>
    <button class="nav-btn" onclick="switchTab('withdrawals', this)">ðŸ’¸ Withdrawals</button>
    <button class="nav-btn" onclick="switchTab('questions', this)">ðŸ’¡ Questions</button>
  </nav>

  <main>

    <!-- ANALYTICS -->
    <div class="tab active" id="tab-analytics">
      <div class="stats-grid">
        <div class="stat-card"><div class="label">Total Revenue</div><div class="value" id="statRevenue">â€”</div><div class="sub">platform fees</div></div>
        <div class="stat-card"><div class="label">Total Volume</div><div class="value" id="statVolume">â€”</div><div class="sub">points wagered</div></div>
        <div class="stat-card"><div class="label">Total Trades</div><div class="value" id="statTrades">â€”</div><div class="sub">all time</div></div>
        <div class="stat-card"><div class="label">Registered Users</div><div class="value" id="statUsers">â€”</div><div class="sub">accounts</div></div>
        <div class="stat-card"><div class="label">Open Markets</div><div class="value" id="statOpen">â€”</div><div class="sub">live now</div></div>
        <div class="stat-card"><div class="label">Points in Wallets</div><div class="value" id="statWallets">â€”</div><div class="sub">total circulating</div></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>Revenue per Market</h3></div>
        <table>
          <thead><tr><th>Question</th><th>Total Pool</th><th>Fee Collected</th><th>Date</th></tr></thead>
          <tbody id="revenueTable"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- MARKETS -->
    <div class="tab" id="tab-markets">
      <div class="card">
        <div class="card-header">
          <h3>All Markets</h3>
          <button class="btn btn-ghost" onclick="loadMarkets()" style="font-size:12px;padding:6px 12px">â†» Refresh</button>
        </div>
        <table>
          <thead><tr><th>Question</th><th>Status</th><th>Closes At</th><th>YES Pool</th><th>NO Pool</th><th>Result</th><th>Action</th></tr></thead>
          <tbody id="marketsTable"><tr><td colspan="7" class="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- CREATE MARKET -->
    <div class="tab" id="tab-create">
      <div class="card">
        <div class="card-header"><h3>Create New Market</h3></div>
        <div style="padding:24px">
          <div class="form-grid">
            <div class="form-group full">
              <label>Question</label>
              <input type="text" id="newQuestion" placeholder="e.g. Will Bitcoin hit $100k by end of 2025?" />
            </div>
            <div class="form-group">
              <label>Closes At (your local time)</label>
              <input type="datetime-local" id="newClosesAt" />
            </div>
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" style="width:auto;padding:11px 32px" onclick="createMarket()">Create Market</button>
          </div>
        </div>
      </div>
    </div>

    <!-- USERS -->
    <div class="tab" id="tab-users">
      <div class="card">
        <div class="card-header">
          <h3>Users & Wallets</h3>
          <button class="btn btn-ghost" onclick="loadUsers()" style="font-size:12px;padding:6px 12px">â†» Refresh</button>
        </div>
        <table>
          <thead><tr><th>Telegram ID</th><th>Username</th><th>Full Name</th><th>Role</th><th>Balance (pts)</th><th>Adjust Balance</th></tr></thead>
          <tbody id="usersTable"><tr><td colspan="6" class="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- LEDGER -->
    <div class="tab" id="tab-ledger">
      <div class="card">
        <div class="card-header">
          <h3>Wallet Ledger â€” Last 100 entries</h3>
          <button class="btn btn-ghost" onclick="loadLedger()" style="font-size:12px;padding:6px 12px">â†» Refresh</button>
        </div>
        <table>
          <thead><tr><th>Time</th><th>Telegram ID</th><th>Type</th><th>Amount</th><th>Balance After</th><th>Note</th></tr></thead>
          <tbody id="ledgerTable"><tr><td colspan="6" class="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- WITHDRAWALS -->
    <div class="tab" id="tab-withdrawals">
      <div class="card">
        <div class="card-header">
          <h3>Withdrawal Requests</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="wdFilter" onchange="loadWithdrawals()" style="background:var(--surface);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:12px">
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="completed">Completed</option>
              <option value="rejected">Rejected</option>
              <option value="all">All</option>
            </select>
            <button class="btn btn-ghost" onclick="loadWithdrawals()" style="font-size:12px;padding:6px 12px">â†» Refresh</button>
          </div>
        </div>
        <table>
          <thead><tr><th>Date</th><th>User</th><th>Points</th><th>EUR</th><th>IBAN</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="wdTable"><tr><td colspan="7" class="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- QUESTION REVIEWS -->
    <div class="tab" id="tab-questions">
      <div class="card">
        <div class="card-header">
          <h3>Question Submissions</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="qFilter" onchange="loadQuestions()" style="background:var(--surface);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:12px">
              <option value="pending">Pending Review</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
              <option value="all">All</option>
            </select>
            <button class="btn btn-ghost" onclick="loadQuestions()" style="font-size:12px;padding:6px 12px">â†» Refresh</button>
          </div>
        </div>
        <table>
          <thead><tr><th>Date</th><th>User</th><th>Question</th><th>Context</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="qTable"><tr><td colspan="6" class="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<div id="toast"></div>

<script>
  // ============================================================
  // CONFIG â€” your Supabase project credentials
  // ============================================================
  var SUPABASE_URL = "https://liketekvzrazheolmfnj.supabase.co";
  var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxpa2V0ZWt2enJhemhlb2xtZm5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDg0MzYsImV4cCI6MjA4NjgyNDQzNn0.8Zo-NJ0QmaH95zt3Nh4yV20M0HM5OOH9V0cDs1xYpPE";
  var ADMIN_PASSWORD = "cassino2025!";

  // FIX: db is declared at the TOP LEVEL so all functions can use it
  // We initialise it once the page loads (Supabase CDN must be ready)
  var db;

  // ============================================================
  // FIX: login() is a GLOBAL function â€” defined outside any wrapper
  // This is why the button onclick="login()" can find it
  // ============================================================
  function login() {
    var pw = document.getElementById("passwordInput").value;
    if (pw === ADMIN_PASSWORD) {
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      startClock();
      loadAnalytics();
      loadMarkets();
    } else {
      document.getElementById("loginError").style.display = "block";
    }
  }

  // Allow pressing Enter in the password field too
  document.addEventListener("DOMContentLoaded", function() {
    // FIX: initialise the Supabase client here â€” CDN is guaranteed loaded by DOMContentLoaded
    db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.getElementById("passwordInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") login();
    });
  });

  // â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startClock() {
    function tick() {
      document.getElementById("clockDisplay").innerText =
        new Date().toUTCString().replace("GMT", "UTC");
    }
    tick();
    setInterval(tick, 1000);
  }

  // â”€â”€ TAB SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchTab(name, btn) {
    document.querySelectorAll(".tab").forEach(function(t) { t.classList.remove("active"); });
    document.querySelectorAll(".nav-btn").forEach(function(b) { b.classList.remove("active"); });
    document.getElementById("tab-" + name).classList.add("active");
    btn.classList.add("active");
    // Auto-load data when switching tabs
    if (name === "markets")     loadMarkets();
    if (name === "users")       loadUsers();
    if (name === "ledger")      loadLedger();
    if (name === "analytics")   loadAnalytics();
    if (name === "withdrawals") loadWithdrawals();
    if (name === "questions")   loadQuestions();
  }

  // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showToast(msg, isError) {
    var t = document.getElementById("toast");
    t.innerText = msg;
    t.style.background = isError ? "#ef4444" : "#22c55e";
    t.style.color = isError ? "#fff" : "#000";
    t.style.display = "block";
    setTimeout(function() { t.style.display = "none"; }, 3500);
  }

  // â”€â”€ ANALYTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadAnalytics() {
    // FIX: fetch markets FIRST so the IDâ†’question map is ready before revenue renders
    var marketsRes  = await db.from("markets").select("id, question");
    var rev         = await db.from("platform_revenue").select("fee_collected, total_pool, market_id, created_at");
    var trades      = await db.from("trades").select("*", { count: "exact", head: true });
    var users       = await db.from("users").select("*", { count: "exact", head: true });
    var open        = await db.from("markets").select("*", { count: "exact", head: true }).eq("status", "open");
    var wallets     = await db.from("wallets").select("balance_points");

    var revenue      = rev.data || [];
    var totalRevenue = revenue.reduce(function(s, r) { return s + Number(r.fee_collected); }, 0);
    var totalVolume  = revenue.reduce(function(s, r) { return s + Number(r.total_pool); }, 0);
    var walletTotal  = (wallets.data || []).reduce(function(s, w) { return s + Number(w.balance_points); }, 0);

    document.getElementById("statRevenue").innerText = totalRevenue.toLocaleString() + " pts";
    document.getElementById("statVolume").innerText  = totalVolume.toLocaleString()  + " pts";
    document.getElementById("statTrades").innerText  = (trades.count || 0).toLocaleString();
    document.getElementById("statUsers").innerText   = (users.count  || 0).toLocaleString();
    document.getElementById("statOpen").innerText    = (open.count   || 0).toLocaleString();
    document.getElementById("statWallets").innerText = walletTotal.toLocaleString() + " pts";

    // Build market ID â†’ question map
    var marketMap = {};
    (marketsRes.data || []).forEach(function(m) { marketMap[m.id] = m.question; });

    var tbody = document.getElementById("revenueTable");
    if (!revenue.length) {
      tbody.innerHTML = '<tr><td colspan="4" class="loading">No revenue yet</td></tr>';
      return;
    }
    tbody.innerHTML = revenue
      .sort(function(a, b) { return new Date(b.created_at) - new Date(a.created_at); })
      .map(function(r) {
        return '<tr>' +
          '<td style="max-width:300px;font-size:12px">' + (marketMap[r.market_id] || r.market_id) + '</td>' +
          '<td>' + Number(r.total_pool).toLocaleString() + ' pts</td>' +
          '<td style="color:#22c55e;font-weight:700">' + Number(r.fee_collected).toLocaleString() + ' pts</td>' +
          '<td style="color:#64748b;font-size:12px">' + new Date(r.created_at).toLocaleString() + '</td>' +
          '</tr>';
      }).join("");
  }

  // â”€â”€ MARKETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadMarkets() {
    var res = await db.from("markets").select("*").order("created_at", { ascending: false });
    var markets = res.data || [];
    var tbody = document.getElementById("marketsTable");

    if (!markets.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="loading">No markets yet</td></tr>';
      return;
    }

    tbody.innerHTML = markets.map(function(m) {
      var statusBadge = '<span class="badge badge-' + m.status + '">' + m.status.toUpperCase() + '</span>';
      var resultBadge = m.result
        ? '<span class="badge badge-' + m.result + '">' + m.result.toUpperCase() + '</span>'
        : '<span style="color:#64748b">â€”</span>';

      var action = '<span style="color:#64748b;font-size:11px">â€”</span>';

      // Only show Set Result when market is CLOSED and no result yet
      if (m.status === "closed" && !m.result) {
        // FIX: use regular straight quotes, no curly/smart quotes anywhere
        action =
          '<select class="result-select" id="result-' + m.id + '">' +
            '<option value="">Set result...</option>' +
            '<option value="yes">YES</option>' +
            '<option value="no">NO</option>' +
          '</select>' +
          '<button class="btn btn-green" style="font-size:11px;padding:4px 10px;margin-left:6px" ' +
            'onclick="setResult(\'' + m.id + '\')">SET</button>';
      } else if (m.status === "settled") {
        action = '<span style="color:#22c55e;font-size:11px">Settled âœ“</span>';
      } else if (m.status === "open") {
        // Extra button to manually close a market early
        action = '<button class="btn btn-ghost" style="font-size:11px;padding:4px 10px" ' +
          'onclick="closeMarket(\'' + m.id + '\')">Close Early</button>';
      }

      return '<tr>' +
        '<td style="max-width:260px;font-size:12px">' + m.question + '</td>' +
        '<td>' + statusBadge + '</td>' +
        '<td style="color:#64748b;font-size:12px">' + new Date(m.closes_at).toLocaleString() + '</td>' +
        '<td style="color:#22c55e;font-weight:700">' + Number(m.yes_pool).toLocaleString() + '</td>' +
        '<td style="color:#ef4444;font-weight:700">' + Number(m.no_pool).toLocaleString() + '</td>' +
        '<td>' + resultBadge + '</td>' +
        '<td>' + action + '</td>' +
        '</tr>';
    }).join("");
  }

  // â”€â”€ CLOSE MARKET EARLY (bonus feature added) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function closeMarket(marketId) {
    if (!confirm("Close this market early? Trading will stop immediately.")) return;
    var res = await db.from("markets").update({ status: "closed" }).eq("id", marketId);
    if (res.error) { showToast("Error: " + res.error.message, true); return; }
    showToast("Market closed âœ“");
    loadMarkets();
  }

  // â”€â”€ SET RESULT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function setResult(marketId) {
    var select = document.getElementById("result-" + marketId);
    var result = select.value;
    if (!result) { showToast("Select YES or NO first", true); return; }

    var res = await db.from("markets").update({ result: result }).eq("id", marketId);
    if (res.error) { showToast("Error: " + res.error.message, true); return; }

    showToast("Result set to " + result.toUpperCase() + " â€” cron will pay winners within 1 minute");
    loadMarkets();
  }

  // â”€â”€ CREATE MARKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function createMarket() {
    var question = document.getElementById("newQuestion").value.trim();
    var closesAt = document.getElementById("newClosesAt").value;
    if (!question) { showToast("Enter a question", true); return; }
    if (!closesAt) { showToast("Set a closing time", true); return; }

    var res = await db.from("markets").insert({
      question: question,
      closes_at: new Date(closesAt).toISOString(),
      status: "open",
      settled: false,
      yes_pool: 0,
      no_pool: 0
    });

    if (res.error) { showToast("Error: " + res.error.message, true); return; }

    showToast("Market created âœ“");
    document.getElementById("newQuestion").value = "";
    document.getElementById("newClosesAt").value = "";
  }

  // â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadUsers() {
    var usersRes   = await db.from("users").select("telegram_id, username, full_name, role");
    var walletsRes = await db.from("wallets").select("telegram_id, balance_points");

    var walletMap = {};
    (walletsRes.data || []).forEach(function(w) { walletMap[w.telegram_id] = w.balance_points; });

    var users = usersRes.data || [];
    var tbody = document.getElementById("usersTable");

    if (!users.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="loading">No users yet</td></tr>';
      return;
    }

    tbody.innerHTML = users.map(function(u) {
      var bal = Number(walletMap[u.telegram_id] || 0).toLocaleString();
      // FIX: use straight quotes in onclick, no curly quotes
      return '<tr>' +
        '<td style="color:#64748b;font-size:12px">' + u.telegram_id + '</td>' +
        '<td>' + (u.username ? '@' + u.username : 'â€”') + '</td>' +
        '<td>' + (u.full_name || 'â€”') + '</td>' +
        '<td><span class="badge badge-' + u.role + '">' + u.role.toUpperCase() + '</span></td>' +
        '<td style="color:#f0b429;font-weight:700">' + bal + ' pts</td>' +
        '<td>' +
          '<input type="number" class="adj-input" id="adj-' + u.telegram_id + '" placeholder="Â±pts" />' +
          '<button class="btn btn-blue" style="font-size:11px;padding:5px 10px;margin-left:6px" ' +
            'onclick="adjustBalance(\'' + u.telegram_id + '\')">ADJUST</button>' +
        '</td>' +
        '</tr>';
    }).join("");
  }

  // â”€â”€ ADJUST BALANCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function adjustBalance(telegramId) {
    var input  = document.getElementById("adj-" + telegramId);
    var amount = parseInt(input.value);
    if (isNaN(amount) || amount === 0) { showToast("Enter a valid amount e.g. 500 or -100", true); return; }

    var walletRes = await db.from("wallets").select("balance_points").eq("telegram_id", telegramId).single();
    var current   = walletRes.data ? walletRes.data.balance_points : 0;
    var newBal    = current + amount;

    if (newBal < 0) { showToast("Would result in negative balance!", true); return; }

    var updateRes = await db.from("wallets").update({ balance_points: newBal }).eq("telegram_id", telegramId);
    if (updateRes.error) { showToast("Error: " + updateRes.error.message, true); return; }

    // Write to ledger for audit trail
    await db.rpc("write_ledger", {
      p_telegram_id:  telegramId,
      p_amount:       amount,
      p_type:         "admin_adjust",
      p_reference_id: null,
      p_note:         "Admin adjusted by " + (amount > 0 ? "+" : "") + amount + " pts"
    });

    showToast("Balance adjusted by " + (amount > 0 ? "+" : "") + amount + " pts âœ“");
    input.value = "";
    loadUsers();
  }

  // â”€â”€ LEDGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadLedger() {
    var res = await db.from("wallet_ledger")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(100);

    var entries = res.data || [];
    var tbody   = document.getElementById("ledgerTable");

    if (!entries.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="loading">No ledger entries yet</td></tr>';
      return;
    }

    tbody.innerHTML = entries.map(function(e) {
      var color = e.amount > 0 ? "#22c55e" : e.amount < 0 ? "#ef4444" : "#64748b";
      var amt   = e.amount > 0 ? "+" + e.amount : String(e.amount);
      return '<tr>' +
        '<td style="color:#64748b;font-size:12px">' + new Date(e.created_at).toLocaleString() + '</td>' +
        '<td style="font-size:12px">' + e.telegram_id + '</td>' +
        '<td><span class="badge badge-user" style="font-size:10px">' + e.type + '</span></td>' +
        '<td style="color:' + color + ';font-weight:700">' + amt + '</td>' +
        '<td>' + Number(e.balance_after).toLocaleString() + ' pts</td>' +
        '<td style="color:#64748b;font-size:12px">' + (e.note || "â€”") + '</td>' +
        '</tr>';
    }).join("");
  }

  // â”€â”€ WITHDRAWALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadWithdrawals() {
    var filter = document.getElementById("wdFilter").value;
    var tbody  = document.getElementById("wdTable");
    tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';

    // FIX: use 'db' not 'sb' â€” 'sb' was the original crash bug
    var query = db.from("withdrawals").select("*").order("created_at", { ascending: false }).limit(200);
    if (filter !== "all") query = query.eq("status", filter);

    var res = await query;
    var data = res.data;

    if (!data || !data.length) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#64748b;padding:24px">No withdrawals found</td></tr>';
      return;
    }

    tbody.innerHTML = data.map(function(w) {
      var statusColors = { pending: "#f0c040", processing: "#4d8fff", completed: "#22c55e", rejected: "#ef4444" };
      var color  = statusColors[w.status] || "#64748b";
      var date   = new Date(w.created_at).toLocaleString();
      var pts    = (w.amount_points || "â€”");
      var eur    = "â‚¬" + Number(w.amount_eur || 0).toFixed(2);
      var iban   = w.iban || "â€”";
      var actions = "";

      // FIX: all quotes here are straight single quotes â€” no curly quotes
      if (w.status === "pending") {
        actions =
          '<button class="btn btn-green" style="font-size:11px;padding:5px 10px;margin-right:4px" ' +
            'onclick="processWd(\'' + w.id + '\', \'approve\')">âœ“ Approve</button>' +
          '<button class="btn btn-red" style="font-size:11px;padding:5px 10px" ' +
            'onclick="processWd(\'' + w.id + '\', \'reject\')">âœ— Reject</button>';
      } else if (w.status === "processing") {
        actions =
          '<button class="btn btn-blue" style="font-size:11px;padding:5px 10px;margin-right:4px" ' +
            'onclick="processWd(\'' + w.id + '\', \'complete\')">âœ“ Mark Complete</button>' +
          '<button class="btn btn-red" style="font-size:11px;padding:5px 10px" ' +
            'onclick="processWd(\'' + w.id + '\', \'reject\')">âœ— Reject</button>';
      } else {
        actions = '<span style="color:#64748b;font-size:11px">' + (w.admin_note || "â€”") + '</span>';
      }

      return '<tr>' +
        '<td style="color:#64748b;font-size:12px">' + date + '</td>' +
        '<td style="font-size:12px">' + w.telegram_id + '</td>' +
        '<td style="font-weight:700;color:#f0c040">' + pts + ' pts</td>' +
        '<td style="font-weight:700">' + eur + '</td>' +
        '<td style="font-family:monospace;font-size:11px;color:#94a3b8">' + iban + '</td>' +
        '<td><span style="color:' + color + ';font-weight:700;font-size:11px;text-transform:uppercase">' + w.status + '</span></td>' +
        '<td>' + actions + '</td>' +
        '</tr>';
    }).join("");
  }

  // â”€â”€ PROCESS WITHDRAWAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function processWd(id, action) {
    var note = "";
    if (action === "reject") {
      note = prompt("Reason for rejection (optional):") || "";
    }
    if (action === "complete") {
      note = prompt("Add a note e.g. bank reference (optional):") || "";
    }

    var res = await fetch(SUPABASE_URL + "/functions/v1/process-withdrawal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ withdrawal_id: id, action: action, admin_note: note })
    });
    var data = await res.json();

    if (!res.ok) {
      showToast("Error: " + (data.error || "Unknown error"), true);
      return;
    }

    showToast(data.message || "Done!");
    loadWithdrawals();
  }

  // â”€â”€ QUESTION REVIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadQuestions() {
    var filter = document.getElementById("qFilter").value;
    var tbody  = document.getElementById("qTable");
    tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';

    // FIX: use 'db' not 'sb' â€” 'sb' was the original crash bug
    var query = db.from("question_submissions").select("*").order("created_at", { ascending: false }).limit(200);
    if (filter !== "all") query = query.eq("status", filter);

    var res = await query;
    var data = res.data;

    if (!data || !data.length) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#64748b;padding:24px">No submissions found</td></tr>';
      return;
    }

    tbody.innerHTML = data.map(function(q) {
      var statusColors = { pending: "#f0c040", approved: "#22c55e", rejected: "#ef4444" };
      var color   = statusColors[q.status] || "#64748b";
      var date    = new Date(q.created_at).toLocaleString();
      var context = q.context ? '<span style="color:#64748b;font-size:11px">' + q.context.slice(0, 80) + '</span>' : "â€”";
      var actions = "";

      // FIX: straight quotes only â€” no curly quotes anywhere
      if (q.status === "pending") {
        actions =
          '<button class="btn btn-green" style="font-size:11px;padding:5px 10px;margin-right:4px" ' +
            'onclick="reviewQuestion(\'' + q.id + '\', \'approve\')">âœ“ Approve</button>' +
          '<button class="btn btn-red" style="font-size:11px;padding:5px 10px" ' +
            'onclick="reviewQuestion(\'' + q.id + '\', \'reject\')">âœ— Reject</button>';
      } else {
        var refundedNote = q.refunded ? ' <span style="color:#22c55e;font-size:10px">(refunded)</span>' : '';
        actions = '<span style="color:#64748b;font-size:11px">' + q.status + refundedNote + '</span>';
      }

      return '<tr>' +
        '<td style="color:#64748b;font-size:12px">' + date + '</td>' +
        '<td style="font-size:12px">' + q.telegram_id + '</td>' +
        '<td style="font-weight:600;max-width:300px">' + q.question + '</td>' +
        '<td style="max-width:200px">' + context + '</td>' +
        '<td><span style="color:' + color + ';font-weight:700;font-size:11px;text-transform:uppercase">' + q.status + '</span></td>' +
        '<td>' + actions + '</td>' +
        '</tr>';
    }).join("");
  }

  // â”€â”€ REVIEW QUESTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function reviewQuestion(id, action) {
    var closesAt = "";

    if (action === "approve") {
      closesAt = prompt("When should this market close? (e.g. 2025-12-31T23:59:00)\nLeave blank to default to 7 days from now:");
      if (closesAt === null) return; // user cancelled
      if (!closesAt.trim()) {
        var d = new Date();
        d.setDate(d.getDate() + 7);
        closesAt = d.toISOString();
      }
    }

    var res = await fetch(SUPABASE_URL + "/functions/v1/review-question", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ submission_id: id, action: action, closes_at: closesAt })
    });
    var data = await res.json();

    if (!res.ok) {
      showToast("Error: " + (data.error || "Unknown error"), true);
      return;
    }

    showToast(action === "approve" ? "Approved â€” market created!" : "Rejected & refunded");
    loadQuestions();
  }
</script>

</body>
</html>
